<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê°ì ê³µì¥</title>
  <script type="module">
    window.addEventListener('DOMContentLoaded', () => {
      const harvestInfo = JSON.parse(localStorage.getItem('harvestInfo') || '{}');
      document.getElementById('potatoCount').textContent = harvestInfo.yield || 0;
      document.getElementById('productName').value = `ê°ìì¹©_${Date.now()}`;
    });
  </script>
  <style>
    body { background: #f6ffe6; font-family: sans-serif; text-align: center; padding: 2rem; }
    h1 { color: #6b8e23; }
    input, button {
      padding: 0.6rem;
      margin-top: 1rem;
      font-size: 1rem;
    }
    #processBtn, #routeBtn {
      background-color: #ffe18d;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>ğŸ¥” ê°ì ê°€ê³µ ê³µì¥</h1>
  <p>ìˆ˜í™•í•œ ê°ì ìˆ˜: <strong id="potatoCount">0</strong> ê°œ</p>
  <p>
    ì œí’ˆ ì´ë¦„ ì…ë ¥: <input type="text" id="productName" placeholder="ì˜ˆ: ì™•ê°ìì¹©">
  </p>
  <button id="processBtn">ğŸ“¦ ê°ì ê°€ê³µ ì‹œì‘</button>
  <div id="nextOptions" style="display:none;">
    <p>ê°ìê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ìŒ ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”:</p>
    <button id="goFarm" class="routeBtn">ğŸŒ± ë†ì¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    <button id="goMarket" class="routeBtn">ğŸ’° ê²½ë§¤ì¥ ê°€ê¸°</button>
  </div>

  <script type="module">
    import { getNickname } from './js/gamja-utils.js';

    const processBtn = document.getElementById("processBtn");
    const nextOptions = document.getElementById("nextOptions");

    processBtn.onclick = async () => {
      const nickname = getNickname();
      const harvestInfo = JSON.parse(localStorage.getItem("harvestInfo") || '{}');
      const productName = document.getElementById("productName").value || 'ë¬´ëª…ê°ì';

      if (!harvestInfo.yield || harvestInfo.yield <= 0) {
        processBtn.style.display = 'none';
        nextOptions.style.display = 'block';
        return;
      }

      const res = await fetch("/api/factory/process", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nickname,
          count: 1, // í•œ ë²ˆì— ê°ì í•˜ë‚˜ ê°€ê³µ
          productName,
          metadata: harvestInfo
        })
      });

      const data = await res.json();
      if (data.success) {
        alert(`'${productName}' ê°€ê³µ ì™„ë£Œ! ê°ì 1ê°œ ì†Œë¹„ë¨.`);
        harvestInfo.yield -= 1;
        localStorage.setItem("harvestInfo", JSON.stringify(harvestInfo));
        document.getElementById("potatoCount").textContent = harvestInfo.yield;
        if (harvestInfo.yield <= 0) {
          processBtn.style.display = 'none';
          nextOptions.style.display = 'block';
        }
      } else {
        alert("ê°€ê³µ ì‹¤íŒ¨: " + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
      }
    };

    document.getElementById("goFarm").onclick = () => {
      location.href = 'gamja-farm.html';
    };
    document.getElementById("goMarket").onclick = () => {
      location.href = 'gamja-market.html';
    };
  </script>
</body>
</html>
