<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>감자 공장</title>
  <script type="module">
    window.addEventListener('DOMContentLoaded', () => {
      const harvestInfo = JSON.parse(localStorage.getItem('harvestInfo') || '{}');
      document.getElementById('potatoCount').textContent = harvestInfo.yield || 0;
      document.getElementById('productName').value = `감자칩_${Date.now()}`;
    });
  </script>
  <style>
    body { background: #f6ffe6; font-family: sans-serif; text-align: center; padding: 2rem; }
    h1 { color: #6b8e23; }
    input, button {
      padding: 0.6rem;
      margin-top: 1rem;
      font-size: 1rem;
    }
    #processBtn, #routeBtn {
      background-color: #ffe18d;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>🥔 감자 가공 공장</h1>
  <p>수확한 감자 수: <strong id="potatoCount">0</strong> 개</p>
  <p>
    제품 이름 입력: <input type="text" id="productName" placeholder="예: 왕감자칩">
  </p>
  <button id="processBtn">📦 감자 가공 시작</button>
  <div id="nextOptions" style="display:none;">
    <p>감자가 없습니다. 다음 작업을 선택하세요:</p>
    <button id="goFarm" class="routeBtn">🌱 농장으로 돌아가기</button>
    <button id="goMarket" class="routeBtn">💰 경매장 가기</button>
  </div>

  <script type="module">
    import { getNickname } from './js/gamja-utils.js';

    const processBtn = document.getElementById("processBtn");
    const nextOptions = document.getElementById("nextOptions");

    processBtn.onclick = async () => {
      const nickname = getNickname();
      const harvestInfo = JSON.parse(localStorage.getItem("harvestInfo") || '{}');
      const productName = document.getElementById("productName").value || '무명감자';

      if (!harvestInfo.yield || harvestInfo.yield <= 0) {
        processBtn.style.display = 'none';
        nextOptions.style.display = 'block';
        return;
      }

      const res = await fetch("/api/factory/process", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nickname,
          count: 1, // 한 번에 감자 하나 가공
          productName,
          metadata: harvestInfo
        })
      });

      const data = await res.json();
      if (data.success) {
        alert(`'${productName}' 가공 완료! 감자 1개 소비됨.`);
        harvestInfo.yield -= 1;
        localStorage.setItem("harvestInfo", JSON.stringify(harvestInfo));
        document.getElementById("potatoCount").textContent = harvestInfo.yield;
        if (harvestInfo.yield <= 0) {
          processBtn.style.display = 'none';
          nextOptions.style.display = 'block';
        }
      } else {
        alert("가공 실패: " + (data.message || '알 수 없는 오류'));
      }
    };

    document.getElementById("goFarm").onclick = () => {
      location.href = 'gamja-farm.html';
    };
    document.getElementById("goMarket").onclick = () => {
      location.href = 'gamja-market.html';
    };
  </script>
</body>
</html>
