<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>씨감자 및 자원 교환소</title>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 2rem;
      text-align: center;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .box {
      background-color: #222;
      padding: 1rem;
      border-radius: 10px;
      margin: 1rem auto;
      max-width: 500px;
    }
    .count {
      font-size: 1.2rem;
      color: #f0c741;
      font-weight: bold;
    }
    button {
      padding: 0.5rem;
      font-size: 1rem;
      margin: 0.5rem;
      border-radius: 5px;
      background-color: #ffaa00;
      color: #000;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #ff8800;
    }
    label {
      display: block;
      margin: 0.5rem;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>🌱 씨감자 & 물/거름 교환소</h1>

  <div class="box">
    <p class="count">닉네임: <span id="nickname">-</span></p>
    <p class="count" id="orcx-token">보유 ORCX: - 개</p>
    <p class="count" id="farming-count">보유 농사 티켓: - 장</p>
    <p class="count" id="water-count">보유 물: - 개</p>
    <p class="count" id="fertilizer-count">보유 거름: - 개</p>
    <button onclick="exchangeSeed()">씨감자 1개 교환 (1 ORCX)</button>
  </div>

  <div class="box">
    <p class="count">보관소 제품으로 물/거름 교환</p>
    <div id="product-list">제품 불러오는 중...</div>
    <button onclick="exchangeSelected('물')">선택 제품으로 물 교환</button>
    <button onclick="exchangeSelected('거름')">선택 제품으로 거름 교환</button>
  </div>

  <div class="box">
    <p id="exchange-status">상태 확인 중...</p>
    <button onclick="goToFarm()">🌾 농장으로 돌아가기</button>
  </div>

  <script>
    const BASE_URL = "https://orcax-farm-6000.onrender.com";
    const kakaoId = localStorage.getItem("kakaoId") || "익명손님";
    const nickname = localStorage.getItem("nickname") || kakaoId;

    document.getElementById("nickname").textContent = nickname;

    function loadStatus() {
      fetch(`${BASE_URL}/api/gamja?nickname=${nickname}`)
        .then(res => res.json())
        .then(data => {
          if (data.newUser) {
            alert("🎁 신규 입장 보상: 토큰 5개, 물 10개, 거름 10개 지급되었습니다!");
          }
          document.getElementById("orcx-token").innerText = `보유 ORCX: ${data.orcx || 0}개`;
          document.getElementById("farming-count").innerText = `보유 농사 티켓: ${data.farmingCount || 0}장`;
          document.getElementById("water-count").innerText = `보유 물: ${data.water || 0}개`;
          document.getElementById("fertilizer-count").innerText = `보유 거름: ${data.fertilizer || 0}개`;
          updateProductList(data.items);
          document.getElementById("exchange-status").innerText = "교환 가능 상태입니다.";
        })
        .catch(err => {
          document.getElementById("exchange-status").innerText = "❌ 상태 정보를 불러올 수 없습니다.";
        });
    }

    function updateProductList(items) {
      const list = document.getElementById("product-list");
      if (!items || items.length === 0) {
        list.innerHTML = "보관된 제품이 없습니다.";
        return;
      }

      list.innerHTML = items.map(item => `
        <label>
          <input type="checkbox" value="${item.name}" data-count="${item.count}" />
          ${item.name}: ${item.count}개
        </label>
      `).join("");
    }

    function exchangeSeed() {
      fetch(`${BASE_URL}/api/buy-seed`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ count: 1, nickname })
      })
        .then(res => res.json())
        .then(data => {
          alert(`✅ ${data.message}`);
          loadStatus();
        })
        .catch(err => {
          alert("❌ 씨감자 교환 실패");
        });
    }

    function exchangeSelected(resource) {
      const selectedCheckboxes = [...document.querySelectorAll("input[type=checkbox]:checked")];
      if (selectedCheckboxes.length === 0) return alert("교환할 제품을 선택하세요.");

      Promise.all(selectedCheckboxes.map(checkbox => {
        const itemType = checkbox.value;
        return fetch(`${BASE_URL}/api/exchange`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nickname, sourceProduct: itemType, itemType: resource })
        })
          .then(res => res.json())
          .then(result => {
            if (result.message) alert(`${itemType} → ${resource} 교환 완료`);
            else throw new Error("응답 없음");
          })
          .catch(err => alert(`⚠️ ${itemType} 교환 실패: ${err.message}`));
      })).then(loadStatus);
    }

    function goToFarm() {
      location.href = "gamja-factory.html";
    }

    loadStatus();
  </script>
</body>
</html>
