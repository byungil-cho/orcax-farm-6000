<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì”¨ê°ì ë° ìì› êµí™˜ì†Œ</title>
  <style>
    body {
      background-color: #111;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 2rem;
      text-align: center;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .box {
      background-color: #222;
      padding: 1rem;
      border-radius: 10px;
      margin: 1rem auto;
      max-width: 500px;
    }
    .count {
      font-size: 1.2rem;
      color: #f0c741;
      font-weight: bold;
    }
    button {
      padding: 0.5rem;
      font-size: 1rem;
      margin: 0.5rem;
      border-radius: 5px;
      background-color: #ffaa00;
      color: #000;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #ff8800;
    }
    label {
      display: block;
      margin: 0.5rem;
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>ğŸŒ± ì”¨ê°ì & ë¬¼/ê±°ë¦„ êµí™˜ì†Œ</h1>

  <div class="box">
    <p class="count">ë‹‰ë„¤ì„: <span id="nickname">-</span></p>
    <p class="count" id="orcx-token">ë³´ìœ  ORCX: - ê°œ</p>
    <p class="count" id="farming-count">ë³´ìœ  ë†ì‚¬ í‹°ì¼“: - ì¥</p>
    <p class="count" id="water-count">ë³´ìœ  ë¬¼: - ê°œ</p>
    <p class="count" id="fertilizer-count">ë³´ìœ  ê±°ë¦„: - ê°œ</p>
    <button onclick="exchangeSeed()">ì”¨ê°ì 1ê°œ êµí™˜ (1 ORCX)</button>
  </div>

  <div class="box">
    <p class="count">ë³´ê´€ì†Œ ì œí’ˆìœ¼ë¡œ ë¬¼/ê±°ë¦„ êµí™˜</p>
    <div id="product-list">ì œí’ˆ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <button onclick="exchangeSelected('ë¬¼')">ì„ íƒ ì œí’ˆìœ¼ë¡œ ë¬¼ êµí™˜</button>
    <button onclick="exchangeSelected('ê±°ë¦„')">ì„ íƒ ì œí’ˆìœ¼ë¡œ ê±°ë¦„ êµí™˜</button>
  </div>

  <div class="box">
    <p id="exchange-status">ìƒíƒœ í™•ì¸ ì¤‘...</p>
    <button onclick="goToFarm()">ğŸŒ¾ ë†ì¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
  </div>

  <script>
    const BASE_URL = "https://orcax-farm-6000.onrender.com";
    const kakaoId = localStorage.getItem("kakaoId") || "ìµëª…ì†ë‹˜";
    const nickname = localStorage.getItem("nickname") || kakaoId;

    document.getElementById("nickname").textContent = nickname;

    function loadStatus() {
      fetch(`${BASE_URL}/api/gamja?nickname=${nickname}`)
        .then(res => res.json())
        .then(data => {
          if (data.newUser) {
            alert("ğŸ ì‹ ê·œ ì…ì¥ ë³´ìƒ: í† í° 5ê°œ, ë¬¼ 10ê°œ, ê±°ë¦„ 10ê°œ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!");
          }
          document.getElementById("orcx-token").innerText = `ë³´ìœ  ORCX: ${data.orcx || 0}ê°œ`;
          document.getElementById("farming-count").innerText = `ë³´ìœ  ë†ì‚¬ í‹°ì¼“: ${data.farmingCount || 0}ì¥`;
          document.getElementById("water-count").innerText = `ë³´ìœ  ë¬¼: ${data.water || 0}ê°œ`;
          document.getElementById("fertilizer-count").innerText = `ë³´ìœ  ê±°ë¦„: ${data.fertilizer || 0}ê°œ`;
          updateProductList(data.items);
          document.getElementById("exchange-status").innerText = "êµí™˜ ê°€ëŠ¥ ìƒíƒœì…ë‹ˆë‹¤.";
        })
        .catch(err => {
          document.getElementById("exchange-status").innerText = "âŒ ìƒíƒœ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        });
    }

    function updateProductList(items) {
      const list = document.getElementById("product-list");
      if (!items || items.length === 0) {
        list.innerHTML = "ë³´ê´€ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      list.innerHTML = items.map(item => `
        <label>
          <input type="checkbox" value="${item.name}" data-count="${item.count}" />
          ${item.name}: ${item.count}ê°œ
        </label>
      `).join("");
    }

    function exchangeSeed() {
      fetch(`${BASE_URL}/api/buy-seed`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ count: 1, nickname })
      })
        .then(res => res.json())
        .then(data => {
          alert(`âœ… ${data.message}`);
          loadStatus();
        })
        .catch(err => {
          alert("âŒ ì”¨ê°ì êµí™˜ ì‹¤íŒ¨");
        });
    }

    function exchangeSelected(resource) {
      const selectedCheckboxes = [...document.querySelectorAll("input[type=checkbox]:checked")];
      if (selectedCheckboxes.length === 0) return alert("êµí™˜í•  ì œí’ˆì„ ì„ íƒí•˜ì„¸ìš”.");

      Promise.all(selectedCheckboxes.map(checkbox => {
        const itemType = checkbox.value;
        return fetch(`${BASE_URL}/api/exchange`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nickname, sourceProduct: itemType, itemType: resource })
        })
          .then(res => res.json())
          .then(result => {
            if (result.message) alert(`${itemType} â†’ ${resource} êµí™˜ ì™„ë£Œ`);
            else throw new Error("ì‘ë‹µ ì—†ìŒ");
          })
          .catch(err => alert(`âš ï¸ ${itemType} êµí™˜ ì‹¤íŒ¨: ${err.message}`));
      })).then(loadStatus);
    }

    function goToFarm() {
      location.href = "gamja-factory.html";
    }

    loadStatus();
  </script>
</body>
</html>
