<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸŒ° OrcaX ë£°ë ›</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ìŠ¤íƒ€ì¼ ìƒëµ â€“ ê¸°ì¡´ ë™ì¼, í•„ìš”ì‹œ ë‹¤ì‹œ ë„£ì–´ë“œë¦´ ìˆ˜ ìˆìŒ */
  </style>
</head>
<body>

  <h1>ğŸŒ° OrcaX ë£°ë ›</h1>

  <div id="wheel-container">
    <div id="pointer"></div>
    <div id="wheel"></div>
  </div>

  <button id="spinBtn">ëŒë¦¬ê¸° (<span id="spinCount">0</span>/5)</button>
  <div id="result">ğŸ¯ ê²°ê³¼: ì—†ìŒ</div>
  <div id="total">ğŸ’° ì´ì : 0 ORCX</div>

  <script>
    const spinBtn = document.getElementById('spinBtn');
    const resultDiv = document.getElementById('result');
    const totalDiv = document.getElementById('total');
    const spinCountSpan = document.getElementById('spinCount');
    const wheel = document.getElementById('wheel');

    let currentRotation = 0;
    let spinCount = 0;
    let totalScore = 0;
    let sessionScore = 0;
    const maxSpins = 5;

    async function fetchTotalScore() {
      const userWallet = localStorage.getItem("orcax_user") || "guest";
      try {
        const response = await fetch(`https://orcax-roulette-backend.onrender.com/api/roulette/score?user=${userWallet}`);
        const data = await response.json();
        return data.totalScore || 0;
      } catch {
        return 0;
      }
    }

    async function saveSessionScore() {
      const userWallet = localStorage.getItem("orcax_user") || "guest";
      if (sessionScore > 0) {
        await fetch(`https://orcax-roulette-backend.onrender.com/api/roulette/addscore`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user: userWallet,
            addedScore: sessionScore
          })
        });
      }
    }

    function updateUI() {
      spinCountSpan.innerText = spinCount;
      totalDiv.innerHTML = `ğŸ’° ì´ì : ${totalScore} ORCX`;
      checkAndShowWithdrawButton();
    }

    function doSpin() {
      const orcaxUser = localStorage.getItem("orcax_user");

      if (spinCount >= 1 && (!orcaxUser || orcaxUser === 'guest')) {
        alert('ğŸ¯ ë‘ë²ˆì§¸ ìŠ¤í•€ë¶€í„°ëŠ” ë¡œê·¸ì¸ ë˜ëŠ” íšŒì›ê°€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤!');
        window.location.href = location.origin + "/auth.html";
        return;
      }

      if (spinCount >= maxSpins) {
        alert("âœ… ë¬´ë£Œ ìŠ¤í•€ì€ ëë‚¬ìŠµë‹ˆë‹¤! ì¶”ê°€ ìŠ¤í•€ì€ 100í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        return;
      }

      spinCount++;
      updateUI();

      const randomExtraRotation = Math.floor(Math.random() * 360);
      const spinDeg = (360 * 5) + randomExtraRotation;
      currentRotation += spinDeg;

      wheel.style.transform = `rotate(-${currentRotation}deg)`;

      setTimeout(() => {
        const normalizedRotation = (currentRotation % 360 + 360) % 360;
        const pointerDeg = (normalizedRotation + 270) % 360;

        let reward = 0;
        let label = '';

        if (pointerDeg >= 0 && pointerDeg < 72) {
          reward = 200; label = 'ë…¸ë‘ìƒ‰';
        } else if (pointerDeg >= 72 && pointerDeg < 144) {
          reward = 300; label = 'íŒŒë€ìƒ‰';
        } else if (pointerDeg >= 144 && pointerDeg < 216) {
          reward = 0; label = 'ê²€ì •ìƒ‰';
        } else if (pointerDeg >= 216 && pointerDeg < 288) {
          reward = 0; label = 'ì£¼í™©ìƒ‰';
        } else {
          reward = 100; label = 'ë¹¨ê°•ìƒ‰';
        }

        resultDiv.innerHTML = `ğŸ¯ ê²°ê³¼: ${label} (${reward > 0 ? reward + ' ORCX' : 'ê½'})`;
        totalScore += reward;
        sessionScore += reward;
        updateUI();

        if (spinCount === maxSpins) {
          saveSessionScore();
        }
      }, 4200);
    }

    spinBtn.addEventListener('click', doSpin);

    (async function init() {
      totalScore = await fetchTotalScore();
      updateUI();

      // âœ… ë¡œê·¸ì¸ í›„ ëŒì•„ì˜¨ ê²½ìš° ìë™ìœ¼ë¡œ 2íšŒì°¨ ìŠ¤í•€
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get("loginSuccess") === "true") {
        // 1íšŒì°¨ ì™„ë£Œ ì²˜ë¦¬
        spinCount = 1;
        setTimeout(() => {
          doSpin(); // 2íšŒì°¨ ìë™ ì‹œì‘
        }, 1000);
      }
    })();

    function checkAndShowWithdrawButton() {
      if (totalScore >= 50000 && !document.getElementById('withdrawBtn')) {
        const btn = document.createElement('button');
        btn.textContent = "ğŸ’° ì¶œê¸ˆ ì‹ ì²­í•˜ê¸°";
        btn.id = "withdrawBtn";
        btn.onclick = requestWithdrawal;
        document.body.appendChild(btn);
      }
    }

    async function requestWithdrawal() {
      const userWallet = localStorage.getItem("orcax_user") || "guest";
      const email = prompt("ì¶œê¸ˆ ì‹ ì²­ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”");

      if (!email) {
        alert('â— ì´ë©”ì¼ ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      const res = await fetch(`https://orcax-roulette-backend.onrender.com/api/roulette/withdraw`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wallet: userWallet, email })
      });

      const data = await res.json();
      if (data.success) {
        alert('âœ… ì¶œê¸ˆ ì‹ ì²­ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        document.getElementById('withdrawBtn').remove();
      } else {
        alert('âŒ ì¶œê¸ˆ ì‹ ì²­ ì‹¤íŒ¨: ' + data.message);
      }
    }
  </script>
</body>
</html>
